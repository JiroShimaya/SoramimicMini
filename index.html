<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Soramimic</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="js/utils.js"></script>
<script src="js/kuromoji/build/kuromoji.js"></script>
</head>
<script>
var makeKanaDist, loadDB, GetYomi, separateKana, convertBar;
//グローバルに使う関数群の宣言
makeKanaDist = makeKanaDist_outer();
loadDB = loadDatabaseText_outer();
GetYomi = MorphologicalAnalyzer();
separateKana = separateKana_outer();
convertBar = convertBar_outer();

function argsort(array) {
    const arrayObject = array.map((value, idx) => { return { value, idx }; });
    arrayObject.sort((a, b) => {
        if (a.value < b.value) {
            return -1;
        }
        if (a.value > b.value) {
            return 1;
        }
        return 0;
    });
    const argIndices = arrayObject.map(data => data.idx);
    return argIndices;
}

function getSimilarWord_outer(wordlist, param){
	var kanadist, ld;
	kanadist = makeKanaDist(param);
	ld = ld_outer(kanadist);

	var memo = {}
	function getSimilarWord_inner(target, length = 1){
		var orglen, cand, cand2, sims, words, args, result, indexes;
		orglen = target.length;
		cand = convertBar(target);

		cand2 = {}
		cand.forEach(function(val){
			var tmplength = val.length;
			if(!(tmplength in cand2)){
				cand2[tmplength] = []
			}
			cand2[tmplength].push(val);
		});

		sims = [];
		words = [];
		for(var i in cand2){
			if(!(i in wordlist)){
				continue;
			}
			wordlist[i].forEach(function(w){
				var tmplist, tSim;
				tmplist = [];
				cand2[i].forEach(function(tar){
					tmplist.push(ld(tar,w[2])/i);
				});
				tSim = Math.min.apply(null,tmplist);

				sims.push(tSim*orglen);
			});
			words = words.concat(wordlist[i]);
		}

		args = argsort(sims);
		result = [];
		indexes = [];
		for(var i = 0; i<args.length;i++){
			var val = args[i];
			var tmpW = words[val];

			var id = tmpW[tmpW.length-1];
			if(indexes.indexOf(id)<0){
				indexes.push(id);
				result.push([target.join(""),tmpW[1], tmpW[0], orgRound(sims[val],100),tmpW[3]]);

			}
			if(result.length == length){
				break;
			}
		}
		return result;
	}

	return getSimilarWord_inner;

}

setTimeout(function(){
	var text, paramter, wordlist;
	$.ajaxSetup({async: false});
	$.get("words/baseball.txt",function(data){
		text = data;
	});
	$.ajaxSetup({async: true});
	parameter = setDefaultParameters({"sameVowel":0.5});
	console.log(parameter);
	wordlist = loadDB(text);
	console.log(wordlist);
	getSimilarWord = getSimilarWord_outer(wordlist,parameter);

	var yomi = "あいうえ";
	yomi = GetYomi(yomi);
	yomi = separateKana(yomi);
	var result = getSimilarWord(yomi,100);
	console.log(result);
	/*
	var yomi = "ギアツ";
	yomi = GetYomi(yomi);
	yomi = separateKana(yomi);
	console.log(yomi);
	*/

},3000);


</script>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-12 col-sm-6">
				<input type = "text" class="form-control">
			</div>
			<div class="col-xs-12 col-sm-6">
				<textarea class="form-control"></textarea>
			</div>
		</div>
	</div>

</body>
</html>