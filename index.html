<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SoramimicMini</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="js/utils.js"></script>
<script src="js/kuromoji/build/kuromoji.js"></script>
</head>
<script>
</script>
<body>
	<span class="loading">Loading...<img src='gif/ajax-loader.gif'></span>
	<div class="container-fluid">
		<div class="row">
			<div class="form-group col-xs-12 radio-wordlist">
				<label class="" for=>単語リストの種類</label>
				<div class="radio-file">
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/baseball.txt" checked="checked">野球選手</label>
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/stations.txt">駅名</label>
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/nations.txt">国名</label>
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/sekitsui.txt">動物</label>
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/pokemon.txt">ポケモン</label>
					<label class="radio-inline"><input type="radio" name="wordfile" value="words/physicist.txt">物理学者</label>
				</div>
				<div>
					<label class="radio-inline radio-original"><input type="radio" name="wordfile" value="original">自作の単語リストを使用</label>
				</div>
			</div>

			<div class="col-xs-12">
				<input type = "text" class="form-control ipt-word" maxlength="10" placeholder="変換したい単語(10文字以内)">
				<button class="btn btn-block btn-primary btn-send">Convert</button>
			</div>
			<div class="col-xs-10">出力結果(左から順位,入力読み,出力読み,出力,非類似度)</div>
			<div class="col-xs-2"><img class="loading2" src='gif/ajax-loader.gif'></div>
			<div class="col-xs-12 div-result"></div>
		</div>
	</div>
</body>
<script>
var makeKanaDist, loadDB, GetYomi, separateKana, convertBar;
var wordlist, getSimilarWord;
//グローバルに使う関数群の宣言

$("div.container-fluid").hide();
$(".loading").show();
$(".loading2").hide();

var promise = MakeTokenizer()
promise
.then(function(tokenizer){
	GetYomi = GetYomi_outer(tokenizer);
	makeKanaDist = makeKanaDist_outer();
	loadDB = loadDatabaseText;
	separateKana = separateKana_outer();
	convertBar = convertBar_outer();
	var param = setDefaultParameters({"sameVowel":1,"sameConsonant":1});
	console.log(param);
	getSimilarWord = getSimilarWord_outer(param);

	wordlist = {}
	$('.radio-file').find("input[type=radio]").prop("disabled",true);
	$('.radio-file').find("input[type=radio]").each(function(index, element){
		var path = $(element).val();
		wordlist[path] = loadDatabaseFile(path);
		$(element).prop("disabled",false);
	});
	$(".container-fluid").show();
	$(".loading").remove();

});
$( '.ipt-word' ).keypress( function ( e ) {
	if ( e.which == 13 ) {
		$(".btn-send").click();
		return false;
	}
} );

function makeDialog(){
	var div = $("<div class='dialog-original'></div>");
	div.append("<textarea class='ta-original-wordlist form-control'></textarea>");


	div.dialog({
		autoOpen: false,
		modal:true,
		title: "単語リストの登録",
		width: $(window).width()*0.9,
		height: $(window).height()*0.9,
		buttons: [
			{
				text: "キャンセル",
				class: "btn-cancel",
				click: function(){
					$(this).dialog("close");
				}
			},
			{
				text: "登録",
				class: "btn-register",
				click: function(){
					var text = $(".ta-original-wordlist").val();
					wordlist["original"] = loadDatabaseText(text);
					localStorage.setItem("originalWordlist",text);
					$(this).dialog("close");
				}
			},
		]
	});
	storageKey = "originalWordlist";
	if(localStorage.getItem(storageKey) === null){
		var initVal = [];
		initVal.push("#使用する単語とその読みのセットを各行につき一セットずつカンマ(,)区切りで入力してください");
		initVal.push("#ひとつの単語に複数の読み方を登録可能です");
		initVal.push("#読み方が一つだけの場合は省略可能です。その場合、システムが自動的に読み方を決定しますが、間違っていることもあります");
		initVal.push("#半角シャープ(#)でコメントアウトできます");
		initVal.push(loadTextFile("words/nations.txt"));
		localStorage.setItem(storageKey,initVal.join("\n"));
	}

	$(".ta-original-wordlist").height("99%");
	$(".ta-original-wordlist").val(localStorage.getItem(storageKey));
}
makeDialog();

$(".radio-original").click(function(){
	$(".dialog-original").dialog("open");
});

$(".btn-send").click(function(){
	$(".loading2").show();
	var text = $(".ipt-word").val();
	if(text == ""){
		return;
	}else if(containAlphabet(text)){
		alert("【変換不可能文字の検出】使用できるのはひらがな・カタカナ・漢字のみです");
		return;
	}
	var wordfile = $("input[name=wordfile]:checked").val();

	text = GetYomi(text);
	text = separateKana(text);
	//console.log(text);
	var result = getSimilarWord(wordlist[wordfile],text,length=100);
	//console.log(result);
	if(result.length == 0){
		$(".loading2").hide();
		$(".div-result").html("うまく変換できる単語を見つけられませんでした");
		return;
	}
	result.forEach(function(value,index){
		result[index] = String(index+1)+","+JSON.stringify(value.slice(0,-1)).slice(1,-1);
	});

	$(".div-result").html(result.join("<br>"));
	$(".loading2").hide();
});
</script>
</html>