<!--
======================================================================
Project Name    : Soramimic
File Name       : index.html
Encoding        : utf-8
Creation Date   : 2019/08/19
 
Copyright © 2019 Jiro Shimaya. All rights reserved.
======================================================================
 -->

<!DOCTYPE html>
<html>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145894423-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-145894423-1');
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Soramimic</title>

<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
 -->
<script src="jquery/ajax-1.7.0-jquery.min.js"></script>
<script src="jquery/jquery-1.11.0.min.js"></script>
<script src="jquery/jquery.cookie.js"></script>
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script src="bootstrap/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<script src="jquery/footerFixed.js"></script>
<script src="js/utils.js"></script>
<script src="js/AjaxUtils.js"></script>
<script src="js/kuromoji/build/kuromoji.js"></script>
<script src="js/roma2kana.js"></script>
</head>
<script>
</script>
<body>
	<span class="loading">Loading...<img src='gif/ajax-loader.gif'></span>
	<div class="container-fluid">
		<div class="row area-setting"></div>
		<!-- 
		<div class="row">
			<div class="col-xs-12">出力結果(上から、入力読み,出力読み,出力元単語)</div>
				<span class="loading2">Converting...<span class="span-progress">0/0</span><img src='gif/ajax-loader.gif'></span>
			<div class="col-xs-12 div-result"></div>
		</div>
		 -->
	</div>
	<div id="footer">
		<br>-----------<br>
		※開発者：<a target="_blank">Jiro Shimaya</a><br>
		※当サイトの開発・運営にご協力くださった皆さまに心より感謝申し上げます（以下、順不同）<br>
		サイト運営費、開発費をご寄付いただいた皆様：
			篠永康平 様、増田一也 様、中崎宏祐 様、ちら@修羅ひよこ大学院生 様、
			高橋仁 様、久保井亮一 様、藤原政彦 様、さいとてつや 様、横田将志 様、松田実 様、
			細田一史 様、渡辺祐太 様
			<br>
		単語リストを提供いただいた皆さま：野球選手表->Moto(選手表ニキ)様と協力者の皆様、駅名表->すきやきすきや様
	</div>
</body>
<script src="js/areaSetting.js"></script>
<script src="js/variables.js"></script>
<script src="js/soramimic.js"></script>
<script>

//$(".btn-send").click(function(){
//	alert("bbbbbb")
//});
const ProcessResult = (command,content) => {
	switch(command){
	default:
		console.log(command,content);
	}
}
//グローバルに使う関数群の宣言
let	isParamChanged = false;
const ag = new AjaxGateway();
if (localStorage.getItem("user_id") === null) {
	localStorage.setItem("user_id","Soramimic_"+getRandomText(12));
}
const user_id = localStorage.getItem("user_id");
ag.Login();

//windowを閉じたらログアウト情報を保存
$(window).on("beforeunload unload",function(e){
	ag.Logout(false);
});

$("div.container-fluid").hide();
$(".loading").show();
$(".loading2").hide();

const getParam = () => {

	let param = {}
	//consnant
	param.SAME_CONSONANT_REWARD = (100-Number($("input[name=consonant]").val()))*0.01;
	//vowel
	param.SAME_VOWEL_REWARD = (100-Number($("input[name=vowel]").val()))*0.01;
	//phrasebreak
	param.SAME_PHRASE_BREAK_REWARD = Number($("input[name=phrasebreak]").val())*1;
	//wordnum
	param.WORD_NUMBER_PENALTY = Number($("input[name=wordnum]").val())*1;

	param.DUPLICATE = ($("input[name=duplication]:checked").val() == "true");

	console.log("param",param);
	return param;
}

const makeDialog = () => {
	const div = $("<div class='dialog-original'></div>");
	div.append("<textarea class='ta-original-wordlist form-control'></textarea>");


	div.dialog({
		autoOpen: false,
		modal:true,
		title: "単語リストの登録",
		width: $(window).width()*0.9,
		height: $(window).height()*0.9,
		buttons: [
			{
				text: "キャンセル",
				class: "btn-cancel",
				click: function(){
					$(this).dialog("close");
				}
			},
			{
				text: "登録",
				class: "btn-register",
				click: function(){
					var text = $(".ta-original-wordlist").val();
					SoramimicPublic.setWordListOriginal(text); 
					localStorage.setItem("originalWordlist",text);
					$(this).dialog("close");
				}
			},
		]
	});
	const storageKey = "originalWordlist";
	if(localStorage.getItem(storageKey) === null){
		const initVal = [];
		initVal.push("#使用する単語とその読みのセットを各行につき一セットずつカンマ(,)区切りで入力してください");
		initVal.push("#ひとつの単語に複数の読み方を登録可能です");
		initVal.push("#読み方が一つだけの場合は省略可能です。その場合、システムが自動的に読み方を決定しますが、間違っていることもあります");
		initVal.push("#半角シャープ(#)でコメントアウトできます");
		initVal.push(loadTextFile("words/nations.txt"));
		localStorage.setItem(storageKey,initVal.join("\n"));
	}

	$(".ta-original-wordlist").height("99%");
	$(".ta-original-wordlist").val(localStorage.getItem(storageKey));
}
makeDialog();

$(".radio-original").click(function(){
	$(".dialog-original").dialog("open");
});

$(".ipt-parameter").change(function(){
	isParamChanged = true;
	console.log("isParamChanged",isParamChanged);
});
$(".ipt-parameter").on("input",function(){
	const val = $(this).val();
	$(this).closest(".input-param").find(".param-value").html(val);

})

$(".btn-send").click(function(){

	$(".loading2").show();
	let text = $(".ipt-word").val();
	console.log(text);
	text = text.replace(/\r?\n/g, '/');
	console.log(text);
	if(text == ""){
		return;
	}
	/*
	else if(containAlphabet(text)){
		alert("【変換不可能文字の検出】使用できるのはひらがな・カタカナ・漢字のみです");
		return;
	}
	*/
	const wordfile = $("input[name=wordfile]:checked").val();

	const param = getParam();
	sendParam = {}
	for(let v of ["SAME_VOWEL_REWARD","SAME_CONSONANT_REWARD","SAME_PHRASE_BREAK_REWARD","WORD_NUMBER_PENALTY"]){
		sendParam[v] = param[v];
	}
	ag.SendConversionInfo(text.length,wordfile,sendParam);
	const result = SoramimicPublic.makeSoramimi(text,SoramimicPublic.getWordList()[wordfile],param);
});
$(".container-fluid").show();
$(".loading").remove();		

SoramimicPublic.setOnFinishedLoadingDatabaseFunc(()=>{
		$(".container-fluid").show();
		$(".loading").remove();		
});
</script>
</html>